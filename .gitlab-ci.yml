image: maven:3.6.3-openjdk-11

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository/
    - target/

build:
  stage: build
  script:
    - "mvn compile -P fmidev -s ./ci_settings.xml  --batch-mode"

test:
  stage: test
  script:
    - "mvn test -P fmidev -s ./ci_settings.xml  --batch-mode"

deploy:
  stage: deploy
  script:
    - "mvn versions:set -DnewVersion=KNMI-4.1.0-${CI_COMMIT_BRANCH}-SNAPSHOT"
    - "mvn deploy  -P fmidev -s ci_settings.xml  --batch-mode"
  only:
    - master
    - branches

deploytags:
  stage: deploy
  script:
    - "mvn versions:set -DnewVersion=${CI_COMMIT_TAG}"
    - "mvn deploy  -P fmidev -s ci_settings.xml  --batch-mode"
  only:
    - tags